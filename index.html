<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA: Link to manifest.json -->
    <link rel="manifest" href="/manifest.json">
    <!-- PWA: Meta tag for app theme color -->
    <meta name="theme-color" content="#2563eb"/> 

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .result-item {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .result-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
        }
        .result-item:hover .overlay {
            opacity: 1;
        }
        /* Style for custom messages */
        .custom-message {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #f59e0b; /* Tailwind yellow-500 */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .custom-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        /* Style for ad placeholders */
        .ad-placeholder {
            background-color: #e0e7ff; /* Light blue */
            border: 1px dashed #6366f1; /* Blue dashed border */
            color: #4338ca; /* Dark blue text */
            text-align: center;
            padding: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8">
        
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI Image Generator</h1>
            <p class="mt-2 text-gray-600">Generate AI images, sign in with your Google account!</p>
        </div>

        <!-- Firebase Auth UI -->
        <div id="auth-status" class="text-center mb-6">
            <div id="user-info" class="hidden">
                <p class="text-gray-700 mb-2">Welcome, <span id="user-display-name" class="font-semibold"></span>!</p>
                <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                </button>
            </div>
            <div id="login-prompt">
                <p class="text-gray-700 mb-2">Please sign in to use the image generator.</p>
                <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center mx-auto">
                    <i class="fab fa-google mr-2"></i>Sign in with Google
                </button>
            </div>
        </div>

        <!-- Prompt Input -->
        <div class="mb-4">
            <label for="prompt" class="block text-sm font-medium text-gray-700 mb-1">Your description (any language):</label>
            <textarea id="prompt" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Example: an astronaut cat riding a horse on Mars"></textarea>
        </div>

        <!-- Options -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="imageCount" class="block text-sm font-medium text-gray-700 mb-1">Number of images:</label>
                <select id="imageCount" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>
            <div>
                <label for="aspectRatio" class="block text-sm font-medium text-gray-700 mb-1">Aspect Ratio:</label>
                <select id="aspectRatio" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="1:1">Square (1:1)</option>
                    <option value="9:16">Portrait (9:16)</option>
                    <option value="16:9">Landscape (16:9)</option>
                </select>
            </div>
        </div>

        <!-- Generate Button -->
        <button id="generateBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center disabled:bg-gray-400">
            <i class="fas fa-magic mr-2"></i>
            <span id="btn-text">Generate Image</span>
        </button>

        <!-- Ad Placement 1: Can be a large banner -->
        <div class="ad-placeholder">
            <!-- Paste your ad code here (e.g., from Google AdSense) -->
            <p>Ad Placement 1 (e.g., 728x90 or 320x50)</p>
            <!-- Example for Google AdSense (uncomment and replace with your IDs): -->
            <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_ADSENSE_ID" crossorigin="anonymous"></script> -->
            <!-- <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-YOUR_ADSENSE_ID" data-ad-slot="YOUR_AD_SLOT_ID" data-ad-format="auto" data-full-width-responsive="true"></ins> -->
            <!-- <script>(adsbygoogle = window.adsbygoogle || []).push({});</script> -->
        </div>

        <!-- Result Section -->
        <div class="mt-6">
            <div id="loader" class="hidden text-center py-8">
                <div class="loader mx-auto"></div>
                <p class="text-gray-600 mt-4">AI is drawing, please wait...</p>
            </div>
            <div id="result-grid">
                <!-- Generated images will be appended here -->
            </div>
            <div id="errorMessage" class="hidden text-center p-4 bg-red-50 rounded-lg">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-2"></i>
                <p class="text-red-600 font-medium">An error occurred. Please try again.</p>
                <p id="errorDetails" class="text-sm text-gray-500 mt-1"></p>
            </div>
        </div>

        <!-- Ad Placement 2: Can be a square or in-article ad -->
        <div class="ad-placeholder">
            <!-- Paste your ad code here -->
            <p>Ad Placement 2 (e.g., 300x250 or in-article ad)</p>
            <!-- Example for Google AdSense (uncomment and replace with your IDs): -->
            <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_ADSENSE_ID" crossorigin="anonymous"></script> -->
            <!-- <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-YOUR_ADSENSE_ID" data-ad-slot="YOUR_AD_SLOT_ID"></ins> -->
            <!-- <script>(adsbygoogle = window.adsbygoogle || []).push({});</script> -->
        </div>

    </div>

    <!-- Footer for legal links -->
    <footer class="mt-8 text-center text-gray-500 text-sm pb-4">
        <p>&copy; 2025 AI Image Generator. All rights reserved.</p>
        <div class="mt-2">
            <a href="/privacy-policy.html" class="text-blue-600 hover:underline mx-2">Privacy Policy</a>
            <span class="text-gray-400">|</span>
            <a href="/terms-of-service.html" class="text-blue-600 hover:underline mx-2">Terms of Service</a>
        </div>
    </footer>

    <!-- Custom Message Box -->
    <div id="customMessage" class="custom-message hidden"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // PWA: Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        

        // Your Firebase configuration
        // YOU NEED TO REPLACE THESE VALUES WITH YOUR ACTUAL FIREBASE PROJECT CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyA3qwF_UuXMr4Dm2xPhJIAJxE1ECEnTQ8s", // This is your Firebase API Key, NOT the AI API Key
            authDomain: "myaigenapp.firebaseapp.com",
            projectId: "myaigenapp",
            storageBucket: "myaigenapp.firebasestorage.app",
            messagingSenderId: "457088629641",
            appId: "1:457088629641:web:332293058a167763ce3f58"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); // Initialize Firestore, useful for storing user data

        // Get UI elements
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btn-text');
        const promptInput = document.getElementById('prompt');
        const imageCountSelect = document.getElementById('imageCount');
        const aspectRatioSelect = document.getElementById('aspectRatio');
        const resultGrid = document.getElementById('result-grid');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');
        const customMessageDiv = document.getElementById('customMessage'); 

        const googleSignInBtn = document.getElementById('google-signin-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoDiv = document.getElementById('user-info');
        const loginPromptDiv = document.getElementById('login-prompt');
        const userDisplayName = document.getElementById('user-display-name');

        // VERY IMPORTANT: THIS API KEY IS USED FOR BOTH TRANSLATION AND IMAGE GENERATION
        // DO NOT PUT YOUR API KEY DIRECTLY IN FRONTEND CODE WHEN DEPLOYING PUBLICLY!
        // For security, you should use a small backend server to make this API call.
        // The backend server will securely store your API Key and return only the result to the frontend.
        const aiApiKey = AIzaSyBzXs5QUpqGbkLty6Z41tQTPdNUS8aiIH0; // <--- REPLACE WITH YOUR ACTUAL API KEY FROM GOOGLE CLOUD OR GEMINI API

        // Function to translate prompt to English
        async function translatePrompt(text) {
            try {
                const chatHistory = [{ role: "user", parts: [{ text: `Translate the following text to English, return only the translation, no other text: "${text}"` }] }];
                const payload = { contents: chatHistory };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${aiApiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Translation HTTP error: ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('No translation received from AI. Invalid response.');
                }
            } catch (error) {
                console.error('Error translating prompt:', error);
                showError(`Translation error: ${error.message}. Please try again in English or with a simpler description.`);
                return null; // Return null if translation fails
            }
        }


        // Hide/show UI elements related to image generation when not signed in
        function updateUIForAuth(user) {
            if (user) {
                // User is signed in
                userInfoDiv.classList.remove('hidden');
                loginPromptDiv.classList.add('hidden');
                userDisplayName.textContent = user.displayName || user.email || 'User';
                generateBtn.disabled = false; // Enable generate button
                promptInput.disabled = false;
                imageCountSelect.disabled = false;
                aspectRatioSelect.disabled = false;
            } else {
                // User is not signed in
                userInfoDiv.classList.add('hidden');
                loginPromptDiv.classList.remove('hidden');
                generateBtn.disabled = true; // Disable generate button
                promptInput.disabled = true;
                imageCountSelect.disabled = true;
                aspectRatioSelect.disabled = true;
                resultGrid.innerHTML = ''; // Clear old results
                showError('Please sign in to generate images.'); // Show message
            }
        }

        // Listen for authentication state changes
        auth.onAuthStateChanged(user => {
            updateUIForAuth(user);
        });

        // Handle Google sign-in
        googleSignInBtn.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                showCustomMessage('Sign in successful!');
            } catch (error) {
                console.error('Google sign-in error:', error);
                showError(`Sign in failed: ${error.message}`);
            }
        });

        // Handle sign-out
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showCustomMessage('You have signed out.');
            } catch (error) {
                console.error('Sign out error:', error);
                showError(`Sign out failed: ${error.message}`);
            }
        });

        generateBtn.addEventListener('click', async () => {
            // Re-check authentication status before generating
            if (!auth.currentUser) {
                showCustomMessage('You need to sign in to generate images.');
                return;
            }

            const prompt = promptInput.value.trim();
            if (!prompt) {
                showCustomMessage('Please enter a description to generate an image.');
                return;
            }

            setLoadingState(true);

            // NEW STEP: Translate prompt to English
            const translatedPrompt = await translatePrompt(prompt);
            if (!translatedPrompt) {
                setLoadingState(false);
                return; // Stop if translation fails
            }
            showCustomMessage('Translating description and generating image...'); // Inform user about translation process

            const imageCount = parseInt(imageCountSelect.value, 10);
            const aspectRatio = aspectRatioSelect.value;
            let finalPrompt = translatedPrompt; // Use the translated prompt

            if (aspectRatio === '9:16') {
                finalPrompt = `portrait orientation, ${translatedPrompt}`;
            } else if (aspectRatio === '16:9') {
                finalPrompt = `landscape orientation, cinematic, ${translatedPrompt}`;
            }

            try {
                const payload = {
                    instances: [{ prompt: finalPrompt }],
                    parameters: { "sampleCount": imageCount }
                };
                
                const imageUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${aiApiKey}`;

                const response = await fetch(imageUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error: ${response.status}`);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0) {
                    displayImages(result.predictions);
                } else {
                    throw new Error('No image received from AI. Invalid response.');
                }

            } catch (error) {
                console.error('Error generating image:', error);
                showError(error.message);
            } finally {
                setLoadingState(false);
            }
        });

        function setLoadingState(isLoading) {
            generateBtn.disabled = isLoading || !auth.currentUser; // Disable if loading OR not signed in
            btnText.textContent = isLoading ? 'Processing...' : 'Generate Image';
            
            if (isLoading) {
                resultGrid.innerHTML = ''; 
                errorMessage.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        function displayImages(predictions) {
            predictions.forEach((prediction, index) => {
                if (prediction.bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${prediction.bytesBase64Encoded}`;
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';

                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = `AI generated image ${index + 1}`;
                    img.className = 'w-full h-full object-cover';

                    const overlay = document.createElement('div');
                    overlay.className = 'overlay';

                    const downloadLink = document.createElement('a');
                    downloadLink.href = imageUrl;
                    const safeFilename = promptInput.value.substring(0, 20).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    downloadLink.download = `${safeFilename}_${index + 1}.png`;
                    downloadLink.innerHTML = `<i class="fas fa-download"></i>`;
                    downloadLink.className = 'p-2 rounded-full bg-white/20 hover:bg-white/40';
                    
                    overlay.appendChild(downloadLink);
                    resultItem.appendChild(img);
                    resultItem.appendChild(overlay);
                    resultGrid.appendChild(resultItem);
                }
            });
        }

        function showError(message) {
            errorMessage.classList.remove('hidden');
            errorDetails.textContent = message;
        }

        function showCustomMessage(message) {
            customMessageDiv.textContent = message;
            customMessageDiv.classList.remove('hidden');
            customMessageDiv.classList.add('show'); 

            setTimeout(() => {
                customMessageDiv.classList.remove('show'); 
                setTimeout(() => {
                    customMessageDiv.classList.add('hidden'); 
                }, 300); 
            }, 3000); 
        }
    </script>
</body>
</html>
